<template>
  <form @submit.prevent="submitForm">
    <div class="w3-row form-ligne">
      <div class="w3-half form-cell">
        <label for="nom">Nom:</label>
        <input
          class="w3-input w3-border"
          type="text"
          id="nom"
          v-model="form.nom_exploitant"
          required
        />
      </div>
      <div class="w3-half form-cell">
        <label for="type">Type:</label>
        <input class="w3-input w3-border" type="text" id="type" v-model="form.type" />
      </div>

      <div class="form-cell">
        <label for="president">Président :</label>
        <select class="w3-input w3-border" v-model="form.president" id="president">
          <option
            v-for="eleveur in eleveurs"
            :key="eleveur.id_eleveur"
            :value="eleveur.id_eleveur"
          >
            {{ eleveur.nom_eleveur }} {{ eleveur.prenom_eleveur }}
          </option>
        </select>
      </div>

      <!-- Sélection des membres -->
      <div class="form-cell">
        <label>Membres :</label>
        <div v-for="eleveur in eleveurs" :key="eleveur.id_eleveur">
          <input type="checkbox" :value="eleveur.id_eleveur" v-model="form.membres" />

          {{ eleveur.nom_eleveur }} {{ eleveur.prenom_eleveur }}
        </div>
      </div>

      <!-- next id pour debug -->
      <div v-if="!isEdit" class="form-cell">
        (Next ID:
        {{ nextId }}
        )
      </div>
    </div>
    <button type="submit">Enregistrer</button>
  </form>
</template>

<script setup>
import { ref, watch, onMounted, onBeforeUnmount } from "vue";

import config from "../../config";
import auth from "../../auth";

const props = defineProps({
  initialForm: Object,
  isEdit: Boolean,
  onSubmit: Function,
});

const eleveurs = ref([]);

const form = ref({
  ...props.initialForm,
});

// Variable pour stocker le nextId
const nextId = ref(null);

const submitForm = () => {
  console.log("Form submitted with:", form.value);
  props
    .onSubmit(form.value)
    .then(() => {
      console.log("Form submission then block executed");
    })
    .catch((error) => {
      console.error("There was an error in form submission!", error);
    });
};

watch(
  () => props.initialForm,
  (newForm) => {
    form.value = { ...newForm, membres: newForm.membres_ids || [] };
  },
  { deep: true }
);

// Hooks de cycle de vie pour déboguer
onMounted(() => {
  console.log("ExploitantForm component mounted");

  if (!props.isEdit) {
    auth.axiosInstance
      .get(`${config.API_BASE_URL}/api/exploitant/getNextId/`)
      .then((response) => {
        nextId.value = response.data.next_id;
        form.value.id_exploitant = nextId.value; // Optionnel: lier cet ID au formulaire si besoin
      })
      .catch((error) => {
        console.error("Erreur lors de la récupération du Next ID", error);
      });
  }

  // Récupère les eleveurs
  auth.axiosInstance
    .get(`${config.API_BASE_URL}/api/eleveur/`)
    .then((response) => {
      eleveurs.value = response.data;
    })
    .catch((error) => {
      console.error("Erreur lors de la récupération de la liste des eleveurs", error);
    });
});

onBeforeUnmount(() => {
  console.log("ExploitantForm component before unmount");
});
</script>

<style scoped>
.form-ligne {
  padding: 8px;
}

.form-cell {
  padding: 8px;
}
</style>
