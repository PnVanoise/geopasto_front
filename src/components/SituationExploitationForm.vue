<template>
  <form @submit.prevent="submitForm">
    <div class="w3-row form-ligne">
      <div class="w3-half form-cell">
        <label for="exploitant">Exploitant :</label>
        <select class="w3-input w3-border" v-model="form.exploitant" id="exploitant">
          <option
            v-for="exploitant in exploitants"
            :key="exploitant.id_exploitant"
            :value="exploitant.id_exploitant"
          >
            {{ exploitant.nom_exploitant }}
          </option>
        </select>
      </div>
      <div class="w3-half form-cell">
        <label for="unite_pastorale">Unité pastorale :</label>
        <select
          class="w3-input w3-border"
          v-model="form.unite_pastorale"
          id="unite_pastorale"
        >
          <option v-for="up in ups.features" :key="up.id" :value="up.id">
            {{ up.properties.nom_up }}
            <!-- properties.code_up }} {{ up.properties.nom_up }} -->
          </option>
        </select>
      </div>
      <!-- next id pour debug -->
    </div>
    <div class="w3-row form-ligne">
      <div class="w3-half form-cell">
        <label for="nom_situ">Nom:</label>
        <input
          class="w3-input w3-border"
          type="text"
          id="nom_situ"
          v-model="form.nom_situation"
          required
        />
      </div>
      <div class="w3-half form-cell">
        <label for="situ_active">Version active ?</label><br />
        <input type="checkbox" id="situ_active" v-model="form.situation_active" />
      </div>
    </div>
    <div class="w3-row form-ligne">
      <div class="w3-half form-cell">
        <label for="dateDebut">Date de début:</label>
        <input
          class="w3-input w3-border"
          type="date"
          id="dateDebut"
          v-model="form.date_debut"
          @keydown.prevent
          @paste.prevent
        />
      </div>
      <div class="w3-half form-cell">
        <label for="dateFin">Date de fin:</label>
        <input
          class="w3-input w3-border"
          type="date"
          id="dateFin"
          v-model="form.date_fin"
          @keydown.prevent
          @paste.prevent
        />
      </div>
    </div>

    <div class="w3-row form-ligne">
      <div class="grid-container">
        <label>Troupeaux :</label>
        <Grid
          :data="elevers"
          :columns="eleGridColumns"
          :bgColor="'#f7ba0b'"
          :columnLabels="eleColumnLabels"
          @edit="eleOnEdit"
          @delete="eleOnDelete"
        >
        </Grid>
        <button type="button" @click="goToAddTroupeau" class="w3-button w3-blue">
          Ajouter un troupeau
        </button>
      </div>
    </div>

    <div class="w3-row form-ligne">
      <div v-if="!isEdit" class="w3-half form-cell">
        (Next ID:
        {{ nextId }}
        )
      </div>
    </div>
    <button type="submit">Enregistrer</button>
  </form>
</template>

<script setup>
import { ref, watch, onMounted, onBeforeUnmount } from "vue";
import { useRouter } from "vue-router";

import Grid from "./Grid.vue";

import config from "../../config";
import auth from "../../auth";

const router = useRouter();

const props = defineProps({
  initialForm: Object,
  isEdit: Boolean,
  onSubmit: Function,
});

const form = ref({ ...props.initialForm });

const exploitants = ref([]);
const ups = ref([]);
const elevers = ref([]);

const eleGridColumns = ref([
  "eleveur_prenom",
  "eleveur_nom",
  "type_cheptel_description",
  "nombre_animaux",
]);
const eleColumnLabels = ref({
  eleveur_prenom: "Prénom Eleveur",
  eleveur_nom: "Nom Eleveur",
  type_cheptel_description: "Type de cheptel",
  nombre_animaux: "Nombre d'animaux",
});

const fetchElevers = () => {
  console.log("fetchElevers called");
  auth.axiosInstance
    .get(`${config.API_BASE_URL}/api/elever/?id_situation=${form.value.id_situation}`)
    .then((response) => {
      elevers.value = response.data;
      console.log("list response data:", response.data);
      console.log("elevers.value:", elevers.value);
    })
    .catch((error) => {
      console.error("There was an error!", error);
    })
    .finally(() => {
      //isLoading.value = false;
      console.log("fetchSituations done");
    });
};

const goToAddTroupeau = () => {
  // Utilisation de l'ID de l'UP pour la navigation
  if (form.value.id_situation) {
    console.log("form.value.id_situation : ", form.value.id_situation);
    router.push({
      name: "addEleverWithSituId",
      params: { situId: form.value.id_situation },
    });
  } else {
    console.warn("L'ID de l'UP n'est pas défini !");
  }
};

// Variable pour stocker le nextId
const nextId = ref(null);

const submitForm = () => {
  console.log("Form submitted with:", form.value);
  props
    .onSubmit(form.value)
    .then(() => {
      console.log("Form submission then block executed");
    })
    .catch((error) => {
      console.error("There was an error in form submission!", error);
    });
};

watch(
  () => props.initialForm,
  (newForm) => {
    form.value = { ...newForm };
  },
  { deep: true }
);

watch(
  () => form.value.id_situation,
  (newId) => {
    if (newId) {
      fetchElevers();
    }
  }
);

// Hooks de cycle de vie pour déboguer
onMounted(() => {
  console.log("SituationExploitationForm component mounted");
  fetchElevers();
  if (!props.isEdit) {
    auth.axiosInstance
      .get(`${config.API_BASE_URL}/api/situationExploitation/getNextId/`)
      .then((response) => {
        nextId.value = response.data.next_id;
        form.value.id_situation = nextId.value; // Optionnel: lier cet ID au formulaire si besoin
      })
      .catch((error) => {
        console.error("Erreur lors de la récupération du Next ID", error);
      });
  }

  auth.axiosInstance
    .get(`${config.API_BASE_URL}/api/exploitant/`)
    .then((response) => {
      exploitants.value = response.data;
      console.log("Exploitants:", exploitants.value);
    })
    .catch((error) => {
      console.error("Erreur lors de la récupération de la liste des exploitants", error);
    });

  // Récupère les UPs
  auth.axiosInstance
    .get(`${config.API_BASE_URL}/api/unitePastorale/`)
    .then((response) => {
      ups.value = response.data;
      console.log("Unites pastorales récupérées:", ups.value);
    })
    .catch((error) => {
      console.error(
        "Erreur lors de la récupération de la liste des unites pastorales",
        error
      );
    });
});

onBeforeUnmount(() => {
  console.log("SituationExploitationForm component before unmount");
});

// Méthode pour gérer l'édition
function eleOnEdit(entry) {
  console.log("Éditer:", entry.id_elever);
  router.push(`/Elever/edit/${entry.id_elever}`);
}

// Méthode pour gérer la suppression
function eleOnDelete(entry) {
  console.log("Supprimer:", entry.id_elever);
  deleteElever(entry.id_elever);
}

const deleteElever = (id) => {
  auth.axiosInstance
    .delete(`${config.API_BASE_URL}/api/elever/${id}/`)
    .then((response) => {
      fetchElevers();
      mainStore.setSuccessMessage("Troupeau - Eleveur supprimé!");
    })
    .catch((error) => {
      console.error("There was an error!", error);
    });
};
</script>

<style scoped>
.form-ligne {
  padding: 8px;
}

.form-cell {
  padding: 8px;
}
</style>
